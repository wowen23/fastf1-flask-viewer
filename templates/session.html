{% extends "base.html" %}

{% block title %}{{ session['event_name'] }} - {{ session['session_type'] }}{% endblock %}

{% block content %}
<h1>{{ session['event_name'] }} - {{ session['session_type'] }}</h1>

<div class="card mb-4">
    <div class="card-header bg-dark text-white">
        <p class="mb-0 text-muted">
            {{ session['location'] }}, {{ session['country'] }} |
            Round {{ session['round_number'] }} |
            {{ session['session_date'][:10] }}
        </p>
    </div>
</div>

<!-- Tabs -->
<ul class="nav nav-tabs" id="sessionTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button"
            role="tab">
            <i class="bi bi-table"></i> Overview
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="progression-tab" data-bs-toggle="tab" data-bs-target="#progression" type="button"
            role="tab">
            <i class="bi bi-graph-up"></i> Race Progression
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="stints-tab" data-bs-toggle="tab" data-bs-target="#stints" type="button" role="tab">
            <i class="bi bi-circle-fill"></i> Stint Analysis
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="pace-tab" data-bs-toggle="tab" data-bs-target="#pace" type="button" role="tab">
            <i class="bi bi-speedometer2"></i> Global Race Pace
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="review-tab" data-bs-toggle="tab" data-bs-target="#review" type="button" role="tab">
            <i class="bi bi-clipboard-data"></i> Stint Review
        </button>
    </li>
</ul>

<div class="tab-content mt-3">
    <!-- Overview Tab -->
    <div class="tab-pane fade show active" id="overview" role="tabpanel">
        <div class="row">
            <div class="col-md-7">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0">Race Results</h4>
                    </div>
                    <div class="card-body">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Pos</th>
                                    <th>Driver</th>
                                    <th>Team</th>
                                    <th>Grid</th>
                                    <th>Points</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for result in results %}
                                <tr>
                                    <td><strong>{{ result['position']|int if result['position'] else 'DNF' }}</strong>
                                    </td>
                                    <td>
                                        <a href="/driver/{{ session['session_id'] }}/{{ result['driver_id'] }}"
                                            class="text-decoration-none">
                                            <span class="badge"
                                                style="background-color: #{{ result['team_color'] }}; color: white;">
                                                {{ result['driver_id'] }}
                                            </span>
                                            {{ result['broadcast_name'] }}
                                        </a>
                                    </td>
                                    <td>{{ result['team_name'] }}</td>
                                    <td>{{ result['grid_position']|int if result['grid_position'] else '-' }}</td>
                                    <td>{{ result['points'] if result['points'] else '-' }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="col-md-5">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h4 class="mb-0">Fastest Laps</h4>
                    </div>
                    <div class="card-body">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Pos</th>
                                    <th>Driver</th>
                                    <th>Best Lap</th>
                                    <th>Avg</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for stat in lap_stats %}
                                <tr>
                                    <td>{{ loop.index }}</td>
                                    <td><strong>{{ stat['driver_id'] }}</strong></td>
                                    <td>{{ '%d:%06.3f' | format((stat['fastest_lap'] // 60)|int, stat['fastest_lap'] %
                                        60) }}</td>
                                    <td class="text-muted">{{ '%d:%06.3f' | format((stat['avg_lap'] // 60)|int,
                                        stat['avg_lap'] % 60) }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Race Progression Tab -->
    <div class="tab-pane fade" id="progression" role="tabpanel">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h4 class="mb-0">Race Progression - Position by Lap</h4>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="lapRange" class="form-label">View Laps:</label>
                    <select id="lapRange" class="form-select form-select-sm"
                        style="width: auto; display: inline-block;">
                        <option value="all">All Laps</option>
                        <option value="0-10">Laps 1-10</option>
                        <option value="10-20">Laps 11-20</option>
                        <option value="20-30">Laps 21-30</option>
                        <option value="30-40">Laps 31-40</option>
                        <option value="40-50">Laps 41-50</option>
                        <option value="50-60">Laps 51-60</option>
                        <option value="60-999">Laps 61+</option>
                    </select>
                </div>
                <canvas id="positionChart" height="150"></canvas>
            </div>
        </div>
    </div>

    <!-- Stint Analysis Tab -->
    <div class="tab-pane fade" id="stints" role="tabpanel">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h4 class="mb-0">Stint Analysis - Tire Strategy</h4>
            </div>
            <div class="card-body">
                <canvas id="stintChart" height="150"></canvas>
            </div>
        </div>
    </div>

    <!-- Global Race Pace Tab -->
    <div class="tab-pane fade" id="pace" role="tabpanel">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h4 class="mb-0"><i class="bi bi-speedometer2"></i> Global Race Pace</h4>
                <p class="mb-0 small">Median lap time across all drivers</p>
            </div>
            <div class="card-body">
                <canvas id="paceChart" height="100"></canvas>
            </div>
        </div>
    </div>

    <!-- Stint Review Tab -->
    <div class="tab-pane fade" id="review" role="tabpanel">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h4 class="mb-0"><i class="bi bi-clipboard-data"></i> Stint Review</h4>
                <p class="mb-0 small">Click on a stint in Stint Analysis to review details, or browse all stints below
                </p>
            </div>
            <div class="card-body">
                <!-- Selected Stint Details -->
                <div id="selectedStintDetails" style="display: none;">
                    <div class="row mb-3">
                        <div class="col">
                            <button class="btn btn-sm btn-secondary" onclick="clearSelectedStint()">
                                <i class="bi bi-arrow-left"></i> Back to All Stints
                            </button>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h5 class="mb-0">Stint Information</h5>
                                </div>
                                <div class="card-body">
                                    <table class="table table-sm">
                                        <tr>
                                            <th>Driver:</th>
                                            <td id="stintDriver"></td>
                                        </tr>
                                        <tr>
                                            <th>Stint Number:</th>
                                            <td id="stintNumber"></td>
                                        </tr>
                                        <tr>
                                            <th>Tire Compound:</th>
                                            <td id="stintCompound"></td>
                                        </tr>
                                        <tr>
                                            <th>Laps:</th>
                                            <td id="stintLaps"></td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h5 class="mb-0">Performance Metrics</h5>
                                </div>
                                <div class="card-body">
                                    <table class="table table-sm">
                                        <tr>
                                            <th>Average Lap Time:</th>
                                            <td id="stintAvg"></td>
                                        </tr>
                                        <tr>
                                            <th>Median Lap Time:</th>
                                            <td id="stintMedian"></td>
                                        </tr>
                                        <tr>
                                            <th>Consistency (CV%):</th>
                                            <td id="stintConsistency"></td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header bg-info text-white">
                                    <h5 class="mb-0"><i class="bi bi-graph-up"></i> Lap Time Evolution</h5>
                                </div>
                                <div class="card-body">
                                    <canvas id="stintLapTimeChart" height="80"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- All Stints List -->
                <div id="allStintsList">
                    <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
                        <table class="table table-hover table-sm">
                            <thead class="sticky-top bg-white">
                                <tr>
                                    <th>Driver</th>
                                    <th>Stint #</th>
                                    <th>Compound</th>
                                    <th>Laps</th>
                                    <th>Avg Lap Time</th>
                                    <th>Median Lap Time</th>
                                    <th>Consistency</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="stintsTableBody">
                                <tr>
                                    <td colspan="8" class="text-center text-muted">Loading stints...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="mt-3">
    <a href="/" class="btn btn-secondary">
        &larr; Back to Sessions
    </a>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://d3js.org/d3.v7.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
    const positionData = {{ position_data| tojson }};
    const stintData = {{ stint_data| tojson }};

    console.log('Position data:', positionData.length, 'points');
    console.log('Stint data:', stintData.length, 'points');

    // Position chart (D3.js Bump Chart)
    const driverData = {};
    positionData.forEach(row => {
        if (!driverData[row.driver_id]) {
            driverData[row.driver_id] = {
                id: row.driver_id,
                name: row.broadcast_name,
                color: '#' + row.team_color,
                data: []
            };
        }
        driverData[row.driver_id].data.push({ x: row.lap_number, y: row.position });
    });

    const drivers = Object.values(driverData);
    const laps = [...new Set(positionData.map(d => d.lap_number))].sort((a, b) => a - b);
    const maxLap = Math.max(...laps);

    let posChartRendered = false;
    document.getElementById('progression-tab').addEventListener('shown.bs.tab', () => {
        if (!posChartRendered) {
            renderBumpChart();
            posChartRendered = true;
        }
    });

    function renderBumpChart() {
        const container = document.getElementById('positionChart').parentNode;
        document.getElementById('positionChart').remove();
        const chartDiv = document.createElement('div');
        chartDiv.id = 'd3BumpChart';
        container.appendChild(chartDiv);

        const margin = { top: 20, right: 100, bottom: 30, left: 40 };
        const width = container.clientWidth - margin.left - margin.right;
        const height = 600 - margin.top - margin.bottom;

        const svg = d3.select("#d3BumpChart")
            .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);

        const x = d3.scaleLinear()
            .domain([0, maxLap])
            .range([0, width]);

        const y = d3.scaleLinear()
            .domain([1, 20]) // Assuming 20 drivers
            .range([0, height]);

        // Axes
        svg.append("g")
            .attr("transform", `translate(0,${height})`)
            .call(d3.axisBottom(x).ticks(10));

        svg.append("g")
            .call(d3.axisLeft(y).ticks(20));

        // Lines
        const line = d3.line()
            .x(d => x(d.x))
            .y(d => y(d.y))
            .curve(d3.curveMonotoneX); // Smooth curve

        const driverGroups = svg.selectAll(".driver-group")
            .data(drivers)
            .enter()
            .append("g")
            .attr("class", "driver-group");

        driverGroups.append("path")
            .attr("class", "line")
            .attr("d", d => line(d.data))
            .attr("fill", "none")
            .attr("stroke", d => d.color)
            .attr("stroke-width", 2)
            .attr("opacity", 0.6)
            .on("mouseover", function (event, d) {
                d3.selectAll(".line").attr("opacity", 0.1);
                d3.select(this).attr("opacity", 1).attr("stroke-width", 4);
                // Tooltip logic here if needed
            })
            .on("mouseout", function (d) {
                d3.selectAll(".line").attr("opacity", 0.6).attr("stroke-width", 2);
            });

        // Add labels at the end
        driverGroups.append("text")
            .datum(d => { return { id: d.id, value: d.data[d.data.length - 1] }; })
            .attr("transform", d => `translate(${x(d.value.x) + 5},${y(d.value.y)})`)
            .attr("dy", "0.35em")
            .style("font-size", "10px")
            .text(d => d.id);
    }

    // Stint chart (D3.js Gantt)
    const stintDriverData = {};
    const driverOrder = [];
    stintData.forEach(row => {
        if (!stintDriverData[row.driver_id]) {
            stintDriverData[row.driver_id] = { finish: row.finish_position || 999, laps: [] };
            driverOrder.push(row.driver_id);
        }
        stintDriverData[row.driver_id].laps.push({
            lap: row.lap_number,
            stint: row.stint,
            compound: row.compound
        });
    });

    driverOrder.sort((a, b) => stintDriverData[a].finish - stintDriverData[b].finish);
    const compoundColors = { HARD: '#2c3e50', MEDIUM: '#f1c40f', SOFT: '#e74c3c', INTERMEDIATE: '#27ae60', WET: '#3498db' };

    let stintChartRendered = false;
    document.getElementById('stints-tab').addEventListener('shown.bs.tab', () => {
        if (!stintChartRendered) {
            renderStintChart();
            stintChartRendered = true;
        }
    });

    function renderStintChart() {
        const container = document.getElementById('stintChart').parentNode;
        document.getElementById('stintChart').remove();
        const chartDiv = document.createElement('div');
        chartDiv.id = 'd3StintChart';
        container.appendChild(chartDiv);

        const margin = { top: 20, right: 30, bottom: 30, left: 60 };
        const width = container.clientWidth - margin.left - margin.right;
        const height = driverOrder.length * 30; // Dynamic height

        const svg = d3.select("#d3StintChart")
            .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);

        const x = d3.scaleLinear()
            .domain([0, d3.max(stintData, d => d.lap_number)])
            .range([0, width]);

        const y = d3.scaleBand()
            .domain(driverOrder)
            .range([0, height])
            .padding(0.2);

        // Axes
        svg.append("g")
            .attr("transform", `translate(0,${height})`)
            .call(d3.axisBottom(x).ticks(10).tickFormat(d => "Lap " + d));

        svg.append("g")
            .call(d3.axisLeft(y));

        // Bars
        driverOrder.forEach(driverId => {
            const laps = stintDriverData[driverId].laps;
            // Group laps into stints
            const stints = [];
            let currentStint = null;

            laps.sort((a, b) => a.lap - b.lap).forEach(lap => {
                if (!currentStint || currentStint.stint !== lap.stint) {
                    if (currentStint) stints.push(currentStint);
                    currentStint = {
                        stint: lap.stint,
                        compound: lap.compound,
                        start: lap.lap,
                        end: lap.lap
                    };
                } else {
                    currentStint.end = lap.lap;
                }
            });
            if (currentStint) stints.push(currentStint);

            svg.selectAll(".stint-bar-" + driverId)
                .data(stints)
                .enter()
                .append("rect")
                .attr("x", d => x(d.start))
                .attr("y", y(driverId))
                .attr("width", d => Math.max(1, x(d.end) - x(d.start)))
                .attr("height", y.bandwidth())
                .attr("fill", d => compoundColors[d.compound] || '#95a5a6')
                .attr("rx", 3)
                .on("mouseover", function (event, d) {
                    d3.select(this).attr("opacity", 0.8);
                })
                .on("mouseout", function (d) {
                    d3.select(this).attr("opacity", 1);
                })
                .on("click", function (event, d) {
                    // Trigger stint review selection
                    const tab = new bootstrap.Tab(document.getElementById('review-tab'));
                    tab.show();
                    setTimeout(() => selectStint(driverId, d.stint), 200);
                });
        });
    }

    // Stint Review JS
    const allStintsData = [];
    let stintLapTimeChart = null;

    function formatLapTime(s) {
        if (!s) return '-';
        const m = Math.floor(s / 60);
        const sec = (s % 60).toFixed(3);
        return `${m}:${sec.padStart(6, '0')}`;
    }

    function populateStintsTable() {
        allStintsData.length = 0;
        const stintMap = {};

        stintData.forEach(row => {
            const key = `${row.driver_id}_${row.stint}`;
            if (!stintMap[key]) {
                stintMap[key] = {
                    driverId: row.driver_id,
                    driver: row.broadcast_name,
                    teamColor: row.team_color,
                    stintNumber: row.stint,
                    compound: row.compound,
                    laps: []
                };
                allStintsData.push(stintMap[key]);
            }
            if (row.lap_time_seconds && row.lap_time_seconds > 0) {
                stintMap[key].laps.push({
                    lapNumber: row.lap_number,
                    lapTime: row.lap_time_seconds
                });
            }
        });

        // Calculate stats
        allStintsData.forEach(stint => {
            const times = stint.laps.map(l => l.lapTime);
            if (times.length > 0) {
                const avg = times.reduce((a, b) => a + b) / times.length;
                const sorted = times.slice().sort((a, b) => a - b);
                const mid = Math.floor(sorted.length / 2);
                const median = sorted.length % 2 ? sorted[mid] : (sorted[mid - 1] + sorted[mid]) / 2;
                const variance = times.reduce((sum, t) => sum + Math.pow(t - avg, 2), 0) / times.length;
                const stdDev = Math.sqrt(variance);
                const cv = (stdDev / avg) * 100;

                stint.stats = { totalLaps: times.length, avgLapTime: avg, medianLapTime: median, consistency: cv };
            } else {
                stint.stats = { totalLaps: 0, avgLapTime: null, medianLapTime: null, consistency: 0 };
            }
        });

        // Populate table
        const tbody = document.getElementById('stintsTableBody');
        tbody.innerHTML = '';
        allStintsData.forEach(stint => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><span class="badge" style="background-color: #${stint.teamColor};">${stint.driverId}</span></td>
                <td>${stint.stintNumber}</td>
                <td><span class="badge" style="background-color: ${compoundColors[stint.compound] || '#999'};">${stint.compound}</span></td>
                <td>${stint.stats.totalLaps}</td>
                <td>${formatLapTime(stint.stats.avgLapTime)}</td>
                <td>${formatLapTime(stint.stats.medianLapTime)}</td>
                <td>${stint.stats.consistency.toFixed(2)}%</td>
                <td><button class="btn btn-sm btn-primary" onclick="selectStint('${stint.driverId}', ${stint.stintNumber})">View</button></td>
            `;
            tbody.appendChild(row);
        });
    }

    function selectStint(driverId, stintNumber) {
        const stint = allStintsData.find(s => s.driverId === driverId && s.stintNumber === stintNumber);
        if (!stint) return;

        document.getElementById('stintDriver').innerHTML = `<span class="badge" style="background-color: #${stint.teamColor};">${stint.driver}</span>`;
        document.getElementById('stintNumber').textContent = stint.stintNumber;
        document.getElementById('stintCompound').innerHTML = `<span class="badge" style="background-color: ${compoundColors[stint.compound]};">${stint.compound}</span>`;
        document.getElementById('stintLaps').textContent = stint.stats.totalLaps;
        document.getElementById('stintAvg').textContent = formatLapTime(stint.stats.avgLapTime);
        document.getElementById('stintMedian').textContent = formatLapTime(stint.stats.medianLapTime);
        document.getElementById('stintConsistency').textContent = `${stint.stats.consistency.toFixed(2)}%`;

        // Create chart (D3.js)
        const container = document.getElementById('stintLapTimeChart').parentNode;
        document.getElementById('stintLapTimeChart').remove();
        const chartDiv = document.createElement('div');
        chartDiv.id = 'd3StintLapTimeChart';
        container.appendChild(chartDiv);

        // Clear previous chart if any
        d3.select("#d3StintLapTimeChart").selectAll("*").remove();

        const margin = { top: 20, right: 30, bottom: 30, left: 50 };
        const width = container.clientWidth - margin.left - margin.right;
        const height = 300 - margin.top - margin.bottom;

        const svg = d3.select("#d3StintLapTimeChart")
            .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);

        const data = stint.laps.map(l => ({ x: l.lapNumber, y: l.lapTime }));

        const x = d3.scaleLinear()
            .domain(d3.extent(data, d => d.x))
            .range([0, width]);

        const y = d3.scaleLinear()
            .domain([d3.min(data, d => d.y) * 0.99, d3.max(data, d => d.y) * 1.01])
            .range([height, 0]);

        svg.append("g")
            .attr("transform", `translate(0,${height})`)
            .call(d3.axisBottom(x).ticks(data.length).tickFormat(d3.format("d")));

        svg.append("g")
            .call(d3.axisLeft(y).tickFormat(d => {
                const m = Math.floor(d / 60);
                const s = (d % 60).toFixed(1).padStart(4, '0');
                return `${m}:${s}`;
            }));

        svg.append("path")
            .datum(data)
            .attr("fill", "none")
            .attr("stroke", '#' + stint.teamColor)
            .attr("stroke-width", 2)
            .attr("d", d3.line()
                .x(d => x(d.x))
                .y(d => y(d.y))
            );

        // Add dots
        const tooltip = d3.select("#d3StintLapTimeChart")
            .append("div")
            .style("opacity", 0)
            .attr("class", "tooltip")
            .style("background-color", "rgba(0,0,0,0.8)")
            .style("color", "white")
            .style("border-radius", "5px")
            .style("padding", "5px")
            .style("position", "absolute")
            .style("pointer-events", "none");

        svg.selectAll("dot")
            .data(data)
            .enter()
            .append("circle")
            .attr("cx", d => x(d.x))
            .attr("cy", d => y(d.y))
            .attr("r", 4)
            .attr("fill", '#' + stint.teamColor)
            .attr("stroke", "white")
            .on("mouseover", function (event, d) {
                tooltip.transition().duration(200).style("opacity", .9);
                const m = Math.floor(d.y / 60);
                const s = (d.y % 60).toFixed(3).padStart(6, '0');
                tooltip.html(`Lap ${d.x}<br/>${m}:${s}`)
                    .style("left", (event.pageX + 10) + "px")
                    .style("top", (event.pageY - 28) + "px");
                d3.select(this).attr("r", 6);
            })
            .on("mouseout", function (d) {
                tooltip.transition().duration(500).style("opacity", 0);
                d3.select(this).attr("r", 4);
            });

        document.getElementById('selectedStintDetails').style.display = 'block';
        document.getElementById('allStintsList').style.display = 'none';
    }

    function clearSelectedStint() {
        d3.select("#d3StintLapTimeChart").selectAll("*").remove();
        document.getElementById('selectedStintDetails').style.display = 'none';
        document.getElementById('allStintsList').style.display = 'block';
    }

    let reviewInitialized = false;
    document.getElementById('review-tab').addEventListener('shown.bs.tab', () => {
        if (!reviewInitialized) {
            populateStintsTable();
            reviewInitialized = true;
        }
    });

    // Pace chart (D3.js)
    const lapTimes = {};
    stintData.forEach(row => {
        const lap = row.lap_number;
        if (!lapTimes[lap]) lapTimes[lap] = [];
        if (row.lap_time_seconds && row.lap_time_seconds > 0) {
            lapTimes[lap].push(row.lap_time_seconds);
        }
    });

    const paceData = [];
    Object.keys(lapTimes).sort((a, b) => a - b).forEach(lap => {
        const times = lapTimes[lap].sort((a, b) => a - b);
        const mid = Math.floor(times.length / 2);
        const median = times.length % 2 === 0 ? (times[mid - 1] + times[mid]) / 2 : times[mid];

        // Calculate standard deviation for "consistency" band
        const avg = times.reduce((a, b) => a + b, 0) / times.length;
        const variance = times.reduce((sum, t) => sum + Math.pow(t - avg, 2), 0) / times.length;
        const stdDev = Math.sqrt(variance);

        paceData.push({
            x: parseInt(lap),
            y: median,
            low: median - stdDev,
            high: median + stdDev,
            count: times.length
        });
    });

    // Calculate overall median for reference
    const allMedians = paceData.map(d => d.y).sort((a, b) => a - b);
    const midIdx = Math.floor(allMedians.length / 2);
    const overallMedian = allMedians.length > 0 ? (allMedians.length % 2 === 0 ?
        (allMedians[midIdx - 1] + allMedians[midIdx]) / 2 :
        allMedians[midIdx]) : 0;

    let paceChartRendered = false;
    document.getElementById('pace-tab').addEventListener('shown.bs.tab', () => {
        if (!paceChartRendered) {
            renderPaceChart();
            paceChartRendered = true;
        }
    });

    function renderPaceChart() {
        const container = document.getElementById('paceChart').parentNode;
        // Remove canvas, add div for D3
        document.getElementById('paceChart').remove();
        const chartDiv = document.createElement('div');
        chartDiv.id = 'd3PaceChart';
        container.appendChild(chartDiv);

        const margin = { top: 20, right: 30, bottom: 30, left: 50 };
        const width = container.clientWidth - margin.left - margin.right;
        const height = 400 - margin.top - margin.bottom;

        const svg = d3.select("#d3PaceChart")
            .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);

        // X Axis
        const x = d3.scaleLinear()
            .domain(d3.extent(paceData, d => d.x))
            .range([0, width]);
        svg.append("g")
            .attr("transform", `translate(0,${height})`)
            .call(d3.axisBottom(x).ticks(10).tickFormat(d => "Lap " + d));

        // Y Axis
        const y = d3.scaleLinear()
            .domain([d3.min(paceData, d => d.low) * 0.98, d3.max(paceData, d => d.high) * 1.02])
            .range([height, 0]);

        const formatTime = d => {
            const m = Math.floor(d / 60);
            const s = (d % 60).toFixed(1).padStart(4, '0');
            return `${m}:${s}`;
        };

        svg.append("g")
            .call(d3.axisLeft(y).tickFormat(formatTime));

        // Confidence Interval (Consistency Band)
        svg.append("path")
            .datum(paceData)
            .attr("fill", "#3498db")
            .attr("fill-opacity", 0.2)
            .attr("stroke", "none")
            .attr("d", d3.area()
                .x(d => x(d.x))
                .y0(d => y(d.low))
                .y1(d => y(d.high))
                .curve(d3.curveMonotoneX)
            );

        // Median Line
        svg.append("path")
            .datum(paceData)
            .attr("fill", "none")
            .attr("stroke", "#3498db")
            .attr("stroke-width", 2)
            .attr("d", d3.line()
                .x(d => x(d.x))
                .y(d => y(d.y))
                .curve(d3.curveMonotoneX)
            );

        // Tooltip
        const tooltip = d3.select("#d3PaceChart")
            .append("div")
            .style("opacity", 0)
            .attr("class", "tooltip")
            .style("background-color", "rgba(0,0,0,0.8)")
            .style("color", "white")
            .style("border-radius", "5px")
            .style("padding", "10px")
            .style("position", "absolute")
            .style("pointer-events", "none");

        // Add dots
        svg.selectAll("dot")
            .data(paceData)
            .enter()
            .append("circle")
            .attr("cx", d => x(d.x))
            .attr("cy", d => y(d.y))
            .attr("r", 4)
            .attr("fill", d => d.y > overallMedian * 1.20 ? "#f1c40f" : "#3498db") // Yellow for slow laps
            .attr("stroke", "white")
            .on("mouseover", function (event, d) {
                tooltip.transition().duration(200).style("opacity", .9);
                let html = `<strong>Lap ${d.x}</strong><br/>Median: ${formatTime(d.y)}<br/>Drivers: ${d.count}`;
                if (d.y > overallMedian * 1.20) html += `<br/><span style="color:#f1c40f">⚠️ Slow Lap</span>`;
                tooltip.html(html)
                    .style("left", (event.pageX + 10) + "px")
                    .style("top", (event.pageY - 28) + "px");
                d3.select(this).attr("r", 6);
            })
            .on("mouseout", function (d) {
                tooltip.transition().duration(500).style("opacity", 0);
                d3.select(this).attr("r", 4);
            });
    }
</script>
{% endblock %}